#!/bin/bash
#################################################################################
##                                                                             ##
##                  c d f 2 r e s e r v o i r                                  ##
##                                                                             ##
##    sh script to convert NetCDF reservoir file into one CLM file             ##
##                                                                             ##
##    Usage: cdf2reservoir grid.clm reservoir.nc reservoir.clm                 ##
##                                                                             ##
## (C) Potsdam Institute for Climate Impact Research (PIK), see COPYRIGHT file ##
## authors, and contributors see AUTHORS file                                  ##
## This file is part of LPJmL and licensed under GNU AGPL Version 3            ##
## or later. See LICENSE file or go to http://www.gnu.org/licenses/            ##
## Contact: https://github.com/PIK-LPJmL/LPJmL                                 ##
##                                                                             ##
#################################################################################

cmd=$(basename $0)
USAGE="Usage: $cmd [-f] grid.clm reservoir.nc reservoir.clm"

force=""

while(( "$#" )); do
  case "$1" in
    -f)
    force="-f"
    shift 1
    ;;
    -*)
     echo >&2 Invalid option $1
     echo >&2 $USAGE
     exit 1
     ;;
   *)
     break
     ;;
  esac
done

if [ $# -lt 3 ]
then
  echo >&2 "Error: Missing argument(s)."
  echo >&2 $USAGE
  exit 1
fi

# create temporary filenames
year=$(mktemp)_year.clm
capacity=$(mktemp)_capacity.clm
area=$(mktemp)_area.clm
inst_cap=$(mktemp)_inst_cap.clm
height=$(mktemp)_height.clm
purpose=$(mktemp)_purpose.clm
cdf2clm -id LPJDAMS -var year -int -o $year $1 $2
cdf2clm -id LPJDAMS -var capacity -float -o $capacity $1 $2
cdf2clm -id LPJDAMS -var area -float -o $area $1 $2
cdf2clm -id LPJDAMS -var inst_cap -int -o $inst_cap $1 $2
cdf2clm -id LPJDAMS -var height -int -o $height $1 $2
cdf2clm -id LPJDAMS -var purpose -int -o $purpose $1 $2
# convert all datatypes to float
setclm type float $year
setclm type float $inst_cap
setclm type float $height
setclm type float $purpose
mergeclm $force -size4 $year $capacity $area $inst_cap $height $purpose $3
#remove temporary files
rm -f $year
rm -f $area
rm -f $capacity
rm -f $inst_cap
rm -f $purpose
