<HTML>
<HEAD>
<LINK REL="stylesheet" HREF="style.css" TYPE="text/css">
<TITLE>
Installing and running LPJmL C Version 6.0.001
</TITLE>
</HEAD>
<BODY>
<H1>Installing and running  LPJmL C Version 6.0.001</H1>

<H2>Installation for Unix-like systems</h2>

This text describes how to install and run  LPJmL on your system. 
The code has been tested for AIX, Linux, Mac OS X, and Windows 
with cygwin and Microsoft C compiler (sequential version without MPI). 
Cygwin is a Linux-like environment for Windows (<A HREF="http://www.cygwin.com">http://www.cygwin.com</A>)
On Mac OS the xcode suite must be installed in order to have the gcc 
compiler.</p>

create lpj directory:</p>
<pre class="example">
mkdir lpjml
</pre>

Go to lpj directory:</p>
<pre class="example">
cd lpjml
</pre>

untar source files</p>
<pre class="example">
gzip -cd lpjml-6.0.001.tar.gz|tar -xf -
</pre>

Directory tree after extracting the tar files:</p>
<pre class="tree">
--lpjml
|
+-config        : OS- and compiler-specific Makefiles
|
+-bin           : Directory for executables and shell scripts
|
+-man           : Manual pages root directory
| |
| +-man1        : Manual pages for programs and scripts
| |
| +-man3        : Manual pages for functions
| |
| +-man5        : Manual pages for file formats
|
+--html         : Documentation and man pages in HTML format
|
+--par          : Parameter files for PFTs and soils
|
+--lib          : library files (created by make)
|
+--include      : include files
|
+--src          : source tree
   |
   +--numeric   : source for numerical routines
   |
   +--tools     : source for tools
   |
   +--pnet      : source for library for distributed networks
   |
   +--climate   : climate code 
   |
   +--lpj       : lpj functions
   |
   +--soil      : soil code
   |
   +--grass     : grass PFT code
   |
   +--tree      : tree PFT code
   |
   +--crop      : crop PFT code
   |
   +--landuse   : land use code
   |
   +--spitfire  : spitfire fire code
   |
   +--reservoir : reservoir code
   |
   +--socket    : socket communication library
   |
   +--image     : Coupler to IMAGE model
   |
   +--netcdf    : NetCDF input/output functions
   |
   +--utils     : utility programs
</pre>

Configure for your operating system</p>
On the HLRS2015 cluster at PIK you have to set the lpjml module for compilation and linking:

<pre class="example">
module load lpjml
</pre>

On a Linux system you have to install the NetCDF, Udunits2, and JSON-C library:

<pre class="example">
sudo apt-get install libnetcdf-dev
sudo apt-get install libudunits2-dev
sudo apt-get install libjson-c-dev
</pre>

and optionally the MPICH parallel library:

<pre class="example">
sudo apt-get install mpich
</pre>

Then LPJmL can be configured via

<pre class="example">
% ./configure.sh
Configuring LPJmL 6.0.001...
Operating system is Linux
Intel MPI found
Create executables with make all
Put . $PWD/bin/lpj_paths.sh in your $HOME/.profile
</pre>
The configure script creates scripts <tt>lpj_paths.sh</tt>/<tt>lpj_paths.csh</tt> for the bash/csh shell that sets all necessary environment variables. They are set by invoking
<pre class="example">
. bin/lpj_paths.sh
</pre>
from the LPJmL root directory. It is recommended to put this statement into your <tt>~./.profile</tt>.
If configure script exits with message "Unsupported operating system",
<tt>Makefile.$osname</tt> is created from <tt>Makefile.gcc</tt> and probably has to be 
modified for your operating system/compiler.
If the configure script finds a MPI environment a parallel version of <tt>lpjml</tt> is built. This is done by checking for <tt>mpicc</tt>/<tt>mpiicc</tt> in the search path for commands.
The configure script creates a copy of the following OS-specific makefiles from
directory <tt>config</tt>:<p>
<table>
<tr bgcolor="#ccccff">
<th>Makefile</th><th>Description<th>
</tr>
<tr>
<td>
<tt>Makefile.aix
</td>
<td>
IBM AIX settings (xlc compiler)
</td>
</tr>
<tr>
<td>
<tt>Makefile.aix_mpi</tt>
</td>
<td>
IBM AIX and MPI environment
</td>
</tr>
<tr>
<td>
<tt>Makefile.gcc</tt>
</td>
<td>
GNU C-compiler settings
</td>
</tr>
<tr>
<td>
<tt>Makefile.intel</tt>
</td>
<td>
Intel C-compiler settings
</td>
</tr>
<tr>
<td>
<tt>Makefile.intel_mpi</tt>
</td>
<td>
Intel C-compiler and Intel MPI settings
</td>
</tr>
<tr>
<td>
<tt>Makefile.cluster2015</tt>
</td>
<td>
Intel C-compiler and Intel MPI on cluster2015 at PIK
</td>
</tr>
<tr>
<td>
<tt>Makefile.mpich</tt>
</td>
<td>
GNU C-Compiler and MPI Chameleon settings
</td>
</tr>
<tr>
<td>
<tt>Makefile.win32</tt>
</td>
<td>
Windows settings (used by <tt>configure.bat</tt>)
</table>

<h3>Compilation flags</h3>

Compilation of <tt>lpjml</tt> is customized by definition of macros in the <tt>LPJFLAGS</tt>
section of <tt>Makefile.inc</tt>:
<pre>
LPJFLAGS= -Dflag1 ...
</pre>
<table>
<tr bgcolor="#ccccff">
<th> Flag</th><th>Description<th>
</tr>
<tr>
<td>
CHECK_BOUNDARY
</td>
<td>
check array boundaries of output
</td>
</tr>
<tr>
<td>
COUPLING_WITH_FMS
</td>
<td>
enable coupling to FMS
</td>
</tr>
<tr>
<td>
DAILY_ESTABLISHMENT
</td>
<td>
enable daily establishment
</td>
</tr>
<tr>
<td>
DEBUG
</td>
<td>
diagnostic output is generated for debugging purposes
</td>
</tr>
<tr>
<td>
IMAGE
</td>
<td>
Coupler to IMAGE model enabled via socket library
</td>
</tr>
<tr>
<td>
LINEAR_DECAY
</td>
<td>
use linearized functions for litter decay
</td>
</tr>
<tr>
<td>
MICRO_HEATING
</td>
<td>
Enable microbial heating
</td>
</tr>
<tr>
<td>
NO_FAIL_BALANCE
</td>
<td>
lpjml does not terminate on balance errors
</td>
</tr>
<tr>
<td>
SAFE
</td>
<td>
code is compiled with additional checks
</td>
</tr>
<tr>
<td>
PERMUTE
</td>
<td>
	Random permutation of PFT list
</td>
</tr>
<tr>
<td>
USE_JSON
</td>
<td>
enable JSON format for LPJmL configuration files
</td>
</tr>
<tr>
<td>
USE_MPI
</td>
<td>
compile parallel version of LPJmL
</td>
</tr>
<tr>
<td>
USE_NETCDF
</td>
<td>
enable NetCDF input/output
</td>
</tr>
<tr>
<td>
USE_NETCDF4
</td>
<td>
enable NetCDF version 4 input/output
</td>
</tr>
<tr>
<td>
USE_RAND48
</td>
<td>
use <tt>drand48()</tt> random number generator
</td>
</tr>
<tr>
<td>
USE_UDUNITS
</td>
<td>
enable unit conversion in NetCDF files
</td>
<tr>
<td>
WITH_FPE
</td>
<td>
floating point exceptions are enabled for debugging purposes
</td>
</tr>
</table>

Create executables:</p>
<pre class="example">
make    
</pre>

One executable in directory <tt>bin</tt> is created:</p>

<tt><A HREF="lpjml.html">lpjml</A></tt>    - LPJmL simulation code</p>

Utility programs are compiled by </p>
<pre class="example">
make utils
</pre>

The following programs are created in the <tt>bin</tt> directory:</p>
<table>
<tr bgcolor="#ccccff">
<th> Program</th><th>Description<th>
</tr>
<tr>
<td>
<A HREF="adddrain.html">
<tt>adddrain</tt>
</A>
</td>
<td>
Adds river basin to coordinate file
<br></td>
</tr>
<tr>
<td>
<A HREF="addheader.html">
<tt>addheader</tt>
</A>
</td>
<td>
Add clm header to raw binary file
<br></td>
</tr>
<tr>
<td>
<A HREF="asc2clm.html">
<tt>asc2clm</tt>
</A>
</td>
<td>
Convert CRU ASCII files to clm data files for LPJmL
<br></td>
</tr>
<tr>
<td>
<A HREF="backtrace.html">
<tt>backtrace</tt>
</A>
</td>
<td>
Create backtrace from core file
<br></td>
</tr>
<tr>
<td>
<A HREF="bin2cdf.html">
<tt>bin2cdf</tt>
</A>
</td>
<td>
Convert binary output files into NetCDF files
<br></td>
</tr>
<tr>
<td>
<A HREF="catclm.html">
<tt>catclm</tt>
</A>
</td>
<td>
Concatenate climate data files
<br></td>
</tr>
<tr>
<td>
<A HREF="cdf2bin.html">
<tt>cdf2bin</tt>
</A>
</td>
<td>
Convert NetCDF files into raw binary data
<br></td>
</tr>
<tr>
<td>
<A HREF="cdf2clm.html">
<tt>cdf2clm</tt>
</A>
</td>
<td>
convert NetCDF files into CLM files
<br></td>
</tr>
<tr>
<td>
<A HREF="cdf2coord.html">
<tt>cdf2coord</tt>
</A>
</td>
<td>
extract CLM grid file from NetCDF file
<br></td>
</tr>
<tr>
<td>
<A HREF="cdf2soil.html">
<tt>cdf2soil</tt>
</A>
</td>
<td>
convert NetCDF file into binary file
<br></td>
</tr>

<tr>
<td>
<A HREF="cft2clm.html">
<tt>cft2clm</tt></A>
</td>
<td>
convert binary land use data files to clm data files for LPJmL
<br></td>
</tr>
<tr>
<td>
<A HREF="clm2cdf.html">
<tt>clm2cdf</tt></A>
</td>
<td>
convert CLM files into NetCDF files
<br></td>
</tr>
<tr>
<td>
<A HREF="cru2clm.html">
<tt>cru2clm</tt>
</A>
</td>
<td>
convert raw binary data files to clm data files for LPJmL
<br></td>
</tr>
<tr>
<td>
<A HREF="cutclm.html">
<tt>cutclm</tt>
</A>
</td>
<td>
Cuts climate data files
<br></td>
</tr>
<tr>
<td>
<A HREF="grid2clm.html">
<tt>grid2clm</tt>
</A>
</td>
<td>
convert grid data file to clm data files for LPJmL
<br></td>
</tr>
<tr>
<td>
<A HREF="lpjcat.html">
<tt>lpjcat</tt>
</A>
</td>
<td>
Concatenates restart files from distributed LPJmL simulations.
<br></tr>
<tr>
<td>
<A HREF="lpjcheck.html">
<tt>lpjcheck</tt>
</A>
</td>
<td>
Checks syntax of LPJmL configuration files 
<br></td>
</tr>
<tr>
<td>
<A HREF="lpj.html">
<tt>lpj</tt>
</A>
</td>
<td>
Dynamic global vegetation model with river routing
<br></td>
</tr>
<tr>
<td>
<A HREF="lpjfiles.html">
<tt>lpjfiles</tt>
</A>
</td>
<td>
Print list of input/output files of LPJmL
<br></td>
</tr>
<tr>
<td>
<A HREF="lpjml.html">
<tt>lpjml</tt>
</A>
</td>
<td>
Dynamic global vegetation model with managed landuse and river routing
<br></td>
</tr>
<tr>
<td>
<A HREF="lpjprint.html">
<tt>lpjprint</tt>
</A>
</td>
<td>
Print contents of restart file of LPJmL model runs 
<br></td>
</tr>
<tr>
<td>
<A HREF="lpjrun.html">
<tt>lpjrun</tt>
</A>
</td>
<td>
Run parallel LPJmL program interactively.
<br></td>
</tr>
<tr>
<td>
<A HREF="manage2js.html">
<tt>manage2js</tt>
</A>
</td>
<td>
Convert management  *.par files to JSON file
<br></td>
</tr>
<tr>
<td>
<A HREF="printclm.html">
<tt>printclm</tt>
</A>
</td>
<td>
Print contents of clm files for LPJmL                   
<br></td>
</tr>
<tr>
<td>
<A HREF="printclm.html">
<tt>printheader</tt>
</A>
</td>
<td>
Print header of clm files for LPJmL                   
<br></td>
</tr>
<tr>
<td>
<A HREF="txt2clm.html">
<tt>txt2clm</tt>
</A>
</td>
<td>
Convert CRU ASCII files to clm data files for LPJmL
<br></td>
</tr>
<tr>
<td>
<A HREF="txt2grid.html">
<tt>txt2grid</tt> 
</A>
</td>
<td>
Convert text files to clm grid data files for LPJmL
<br></td>
</tr>
<tr>
<td>
<A HREF="cat2bsq.html">
<tt>cat2bsq</tt>
</A>
</td>
<td>
Concatenates output files from distributed LPJmL simulations
<br></td>
</tr>
</table>
An installation directory can be defined during configuration:
<pre class="example">
./configure.sh -prefix /data/biosx/lpjml-6.0.001
</pre>
Then the binaries can be copied in the installation directory by invoking</p>
<pre class="example">
make install
</pre>

The necessary parameter and include files will be copied, too.

Create output and restart directory:</p>

<pre class="example">
make test
</pre>

On the compute cluster at PIK it is better to create symbolic links of the 
input, output, and restart directory to the parallel GPFS filesystem <tt>/scratch</tt>.
This improves performance in particular for the parallel code. </p>
<pre class="example">
% mkdir -p /p/tmp/$USER/lpj/restart
% mkdir -p /p/tmp/$USER/lpj/output
% ln -sf /p/tmp/$USER/lpj/restart restart
% ln -sf /p/tmp/$USER/lpj/output output
</pre>

<H3>Man pages</h3>

Manual pages for the <tt>man</tt> command are located in the <tt>$LPJROOT/man</tt> directory. The MANPATH variable is set by the <tt>lpj_paths.sh</tt> script.
HTML versions of the manual pages are located <A HREF="manpages.html">here</A>.

Invoking</p>

<pre class="example">
apropos lpj
</pre>

yields list of man pages related to LPJmL.</p>

<h2>Running the program</h2>

Sequential version can be started by invoking:</p>

<pre class="example">
./bin/lpjml 
</pre>
By default the configuration file <tt>lpjml.js</tt> is read. The contents of this file can be viewed <A HREF="lpjml_example.html">here</A>.
If you run <tt>lpjml</tt> outside the root directory of LPJmL, the following environment
variable should be set (done by <tt>lpj_paths.sh</tt>):</p>

<pre class="example">
export LPJROOT=$HOME/lpjml
</pre>
Then all includes are found.

<h3>Environment variables</h3>

The following environment variables are used by LPJmL:</p>
<table>
<tr bgcolor="#ccccff">
<th> Environment variable</th><th>Description<th>
</tr>
<tr><td>
LPJCONFIG
</td><td>
default LPJmL configuration filename
</td></tr>
<tr><td>
LPJPREP
</td><td>
defines preprocessor command for LPJmL configuration  file, default
is <tt>cpp -P</tt>
</td></tr>
<tr><td>
LPJROOT        
</td><td>
defines the root directory for LPJmL. This directory is added to the 
 include directories of the preprocessor. Is usually set by <tt>lpj_paths.sh</tt>.
</td></tr>
<tr><td>
LPJIMAGE
</td><td>
sets host where IMAGE model is running
</td></tr>
<tr><td>
LPJWAITIMAGE
</td><td>
sets time to wait for connection to  IMAGE model
</td></tr>
<tr><td>
LPJINPATH   
</td><td>
Path append to the input filenames. Only done for filenames
 without absolute path.
</td></tr>
<tr><td>
LPJRESTARTPATH 
</td><td>
Path append to the restart filenames. Only done for filenames
 without absolute path.
</td></tr>
<tr><td>
LPJOPTIONS  
</td><td>
preprocessor runtime options for LPJmL
</td></tr>
<tr><td>
LPJOUTPATH
</td><td>
Path appended to the output filenames. Only done for filenames
 without absolute path.
</td></tr>
<tr><td>
LPOUTPUT
</td><td>
Default method for generating output files. Valid values
 are write, mpi2, gather, and socket. Method mpi2 and gather are used by the MPI version only.
</td></tr>
</table>
<h3>Runtime options of LPJmL</h3>

The following runtime options are defined for <tt>lpjml</tt>: </p>
<table>
<tr bgcolor="#ccccff">
<th> Option</th><th>Description<th>
</tr>
<tr><td>
-Iincludepath
</td><td>
Adds include path for LPJmL configuration file
</td></tr>
<tr><td>
-Dmacro[=value]   
</td><td>
Defines macro
</td></tr>
<tr><td>
-h          
</td><td>
print usage of lpjml
</td></tr>
<tr><td>
-l
</td><td>
print license
</td></tr>
<tr><td>
-v         
</td><td>
print compiler used and LPJmL flags set
</td></tr>
<tr><td>
-param
</td><td>
print LPJmL parameter for soils and PFTs
</td></tr>
<tr><td>
-pp cmd
</td><td>
set preprocessor program to cmd. Default is cpp -P.
</td></tr> 
<tr><td>
-fpe     
</td><td>
enable floating point exceptions
</td></tr>
<tr><td>
-image host
</td><td>
set host where IMAGE model is running. Default is 'localhost'. Option is only available for the IMAGE version.
</td></tr>
<tr><td>
-wait time
</td><td>
set time to wait for connection to IMAGE model measured in sec. Default is 10 sec.
</td></tr>
<tr><td>
-output method 
</td><td>
Method for generating output files. Valid values for 
    are write, mpi2, gather, and socket. Methods mpi2 and gather are only available for the
    MPI version
</td></tr>
<tr><td>
-inpath dir  
</td><td>
input directory path
</td></tr>
<tr><td>
-outpath dir  
</td><td>
output directory path
</td></tr>
<tr><td>
-restartpath dir 
</td><td>
restart directory path
</td></tr>
</table>
The first two options will be sent to the preprocessor.

For the parallel version SLURM and LoadLeveler files for Linux and AIX are provided.
A job can be submitted by invoking the <tt><A HREF="lpjsubmit.html">lpjsubmit</A></tt> script:</p>
<pre class="example">
lpjsubmit ntasks LPJmL_args...
</pre>

Depending on your MPI version installed the program can be started interactively:</p>

<pre class="example">
% mpirun -np 256 $LPJROOT/bin/lpjml -DCHECKPOINT
******************************************************************************
****         _     ____     _           _        __          ___          ****
****        | |   |  _ \   | |_ __ ___ | |      / /_        / _ \         ****
****        | |   | |_) |  | | '_ ` _ \| |     | '_ \      | | | |        ****
****        | |___|  __/ |_| | | | | | | |___  | (_) |  _  | |_| |        ****
****        |_____|_|   \___/|_| |_| |_|_____|  \___/  (_)  \___/         ****
****                                                                      ****
****                lpjml C Version 6.0.001 (Mar 22 2021)                 ****
****    Dynamic global vegetation model with natural and managed land     ****
****                          Compiled for Linux                          ****
****       (C) Potsdam Institute for Climate Impact Research (PIK),       ****
****                          see COPYRIGHT file                          ****
****              Authors, and contributors see AUTHORS file              ****
**** This version of LPJmL is licensed under GNU AGPL Version 3 or later  ****
****        See LICENSE file or go to http://www.gnu.org/licenses/        ****
****                 or invoke lpjml -l to print license                  ****
****             Contact: https://github.com/PIK-LPJmL/LPJmL              ****
****                                                                      ****
******************************************************************************

Simulation with random precipitation, fire, shuffle climate, 
equilsoil is called, nitrogen limitation, permafrost, new phenology.

Working directory: /home/bloh/git/lpjml_methane
Starting from scratch.
Input files:
Variable   Fmt  Varname Filename
---------- ---- ------- ------------------------------------------------------
soil       meta         /p/projects/lpjml/input/historical/input_VERSION2/soil.descr
coord      clm          /p/projects/lpjml/input/historical/input_VERSION2/grid.bin
kbf        cdf  KBF     /p/projects/lpjml/input/historical/input_VERSION2/kbf_mar.nc
slope      clm          /p/projects/lpjml/input/historical/input_VERSION2/GloSlope-30as_mean.clm
slope_min  clm          /p/projects/lpjml/input/historical/input_VERSION2/GloSlope-30as_min.clm
slope_max  clm          /p/projects/lpjml/input/historical/input_VERSION2/GloSlope-30as_max.clm
temp       clm          /p/projects/lpjml/input/historical/CRUDATA_TS3_23/cru_ts3.23.1901.2014.tmp.dat.clm
prec       clm          /p/projects/lpjml/input/historical/CRUDATA_TS3_23/gpcc_v7_cruts3_23_precip_1901_2013.clm
hydrotopes clm          /p/projects/lpjml/input/historical/input_VERSION2/hydro2_shuffle.bin
lwnet      clm          /p/projects/lpjml/input/historical/input_VERSION2/lwnet_erainterim_1901-2011.clm
swdown     clm          /p/projects/lpjml/input/historical/input_VERSION2/swdown_erainterim_1901-2011.clm
no3_depo   clm          /p/projects/lpjml/input/historical/input_VERSION2/no3_deposition_rcp8p5.clm
nh4_depo   clm          /p/projects/lpjml/input/historical/input_VERSION2/nh4_deposition_rcp8p5.clm
soilpH     clm          /p/projects/lpjml/input/historical/input_VERSION2/soil_ph.clm
co2        txt          /p/projects/lpjml/input/historical/input_VERSION2/co2_1841-2012.dat
ch4        txt          /home/bloh/git/lpjml_methane/CH4_concentration_lpj.csv
windspeed  clm          /p/projects/lpjml/input/historical/input_VERSION2/mwindspeed_1860-2100_67420.clm
wetdays    clm          /p/projects/lpjml/input/historical/CRUDATA_TS3_23/gpcc_v7_cruts3_23_wet_1901_2013.clm
---------- ---- ------- ------------------------------------------------------
Writing restart file '/p/tmp/bloh/lpjml51/lpjml_methane/restart/restart_1840_nv_stdfire.lpj' after year 1840.
Checkpoint restart file: '/p/tmp/bloh/lpjml51/lpjml_methane/restart/restart_checkpoint.lpj'.
Random seed: 2
Number of output files:       1
Output written in year:       -6099
Byte order in output files:   little endian
Output method:                gathered
Variable   Fmt Unit Type  dt  nbd Filename
---------- --- ---- ----- --- --- ---------------------------------------------
globalflux txt -    float Y     1 /p/tmp/bloh/lpjml51/lpjml_methane/output/globalflux.csv
---------- --- ---- ----- --- --- ---------------------------------------------
Spinup years:                  8000
Cycle length during spinup:      30
First year:                    1901
Last year:                     1901
Number of grid cells:         67420
==============================================================================
Memory allocated for output: 360 bytes/cell
Simulation begins...
Spinup using climate starting from year 1901

                  Carbon flux (GtC)                    Water (km3)          CH4 fluxes (TgCH4)              Carbon (GtC)                    Nitrogen (TgN)
       --------------------------------------- -------------------------- -------------------------------- ------------------------------ --------------------------------
Spinup NEP     estab   fire    total   NPP     transp     evap    interc  CH4 emiss.   CH4 sink   CH4 fire SoilC     slowSoilC  VegC      nuptake ndemand  nlosses ninflux
------ ------- ------- ------- ------- ------- ---------- ------- ------- ---------- ---------- ---------- --------- ---------- --------- ------- -------- ------- -------
 -6099 -49.886   0.787   0.000 -49.099   0.000        0.0 56735.6     0.0     0.396      0.003      0.000   5523.291   2784.612      0.787     0.0      0.0 11160.6    25.1
 -6098 -43.955   0.210   0.000 -43.745   5.999      429.4 61003.6     3.3     0.516      0.003      0.000   5473.425   2781.370      5.846    80.0      4.6  4267.8    23.4
 -6097  -3.584  -0.185   0.007  -3.775  46.035    16402.7 44612.2   267.4     0.578      0.002      0.000   5427.778   2777.956     40.529   656.1    184.6  3268.4    26.8
 -6096  36.046   0.014   0.100  35.959  88.924    52714.1 13916.9  5864.1     0.612      0.003      0.000   5394.724   2774.850     92.227  1986.8  10231.2  1995.4    40.3
 -6095  34.628   0.050   0.285  34.394  96.454    54949.7 11028.5 10955.5     0.439      0.003      0.001   5385.658   2772.066    110.524  2536.3  19110.9  1206.2    46.7
 -6094  13.185   0.078   0.356  12.907  86.248    53478.4 10978.0 11687.2     0.385      0.003      0.001   5387.845   2769.429    102.815  2088.2  27462.9   925.1    52.4
 -6093   8.140   0.075   0.392   7.824  89.409    56539.9 10475.4 11263.1     0.388      0.003      0.001   5392.520   2766.808     94.967  1707.3  30315.1   914.5    59.6
 -6092  -2.067   0.074   0.461  -2.454  84.851    54574.8 10583.5  9744.7     0.374      0.003      0.001   5396.254   2764.190     83.420  1484.9  26096.2   928.7    63.8
 -6091  -3.219   0.072   0.364  -3.511  86.837    55537.5 10553.2  8636.0     0.372      0.003      0.001   5398.048   2761.491     76.699  1403.0  21777.8   882.8    68.3
 -6090  -8.069   0.097   0.345  -8.317  83.941    55377.1 10765.7  7582.2     0.375      0.003      0.001   5395.888   2758.833     71.847  1359.4  16877.9   886.3    75.1
 -6089  -6.790   0.084   0.378  -7.084  85.031    55460.5 10487.6  7356.5     0.390      0.003      0.001   5392.566   2756.114     68.506  1445.8  14802.8   862.7    76.8
 -6088 -11.569   0.084   0.383 -11.868  80.467    53745.0 10383.9  6774.6     0.413      0.003      0.001   5385.784   2753.389     65.438  1465.6  13602.0   845.6    82.8
 -6087  -6.078   0.078   0.357  -6.357  86.355    55690.8 10649.1  6507.9     0.421      0.003      0.001   5379.245   2750.626     65.950  1455.7  13117.8   895.2    85.3
 -6086 -11.280   0.096   0.348 -11.532  81.594    54111.8 10367.9  6190.3     0.442      0.003      0.001   5370.590   2747.759     64.216  1546.1  13078.0   836.9    90.7
 -6085  -7.077   0.074   0.362  -7.365  85.224    54169.7 10658.8  6069.6     0.435      0.003      0.001   5361.899   2744.899     65.726  1504.1  12745.9   833.6    92.6
...
  1890   6.423   0.078   3.333   3.168  88.102    52166.4  9267.1 11838.7     0.826      0.003      0.014   2770.640    833.635    892.557  1843.7  28459.1   205.1   148.0
  1891   4.257   0.086   3.305   1.038  86.357    51874.6  8935.2 12388.3     0.843      0.003      0.014   2771.122    833.671    892.115  1833.5  28302.3   209.4   150.0
  1892   8.775   0.079   3.216   5.638  89.209    52640.0  9061.1 12538.1     0.875      0.003      0.013   2772.387    833.688    894.709  1814.1  28495.2   214.4   148.5
  1893   3.281   0.095   3.227   0.149  86.028    52290.1  9191.9 12198.6     0.839      0.003      0.013   2773.114    833.751    892.735  1848.1  28732.8   201.3   148.2
  1894   5.752   0.083   3.387   2.448  88.536    52806.1  9612.2 12094.5     0.806      0.003      0.014   2773.351    833.811    893.970  1845.4  28541.7   207.9   147.8
  1895   5.669   0.077   3.434   2.313  88.117    52674.9  8986.0 11952.5     0.817      0.003      0.014   2774.159    833.869    894.876  1850.9  28602.8   210.0   149.5
  1896   3.241   0.073   3.539  -0.226  86.015    51630.3  8977.4 11959.5     0.826      0.003      0.015   2774.758    833.906    893.291  1819.3  28175.3   223.0   148.9
  1897   4.470   0.096   3.227   1.338  87.168    52310.0  9312.2 11820.2     0.814      0.003      0.013   2775.098    833.954    893.709  1825.9  28611.5   252.7   150.4
  1898   5.089   0.078   3.271   1.896  87.415    52182.8  8951.7 12425.0     0.840      0.003      0.014   2775.339    833.986    894.675  1818.1  29051.2   210.1   150.0
  1899   4.889   0.084   3.326   1.646  86.880    52178.8  9069.7 12017.0     0.845      0.003      0.014   2775.832    834.013    895.346  1807.5  28892.2   221.3   148.8
  1900   7.009   0.090   3.067   4.032  88.951    52889.6  9386.7 12244.5     0.851      0.003      0.013   2776.633    834.033    898.088  1838.4  29322.6   208.0   149.5

                  Carbon flux (GtC)                    Water (km3)          CH4 fluxes (TgCH4)              Carbon (GtC)                    Nitrogen (TgN)
       --------------------------------------- -------------------------- -------------------------------- ------------------------------ --------------------------------
Year   NEP     estab   fire    total   NPP     transp     evap    interc  CH4 emiss.   CH4 sink   CH4 fire SoilC     slowSoilC  VegC      nuptake ndemand  nlosses ninflux
------ ------- ------- ------- ------- ------- ---------- ------- ------- ---------- ---------- ---------- --------- ---------- --------- ------- -------- ------- -------
  1901   4.264   0.089   3.265   1.088  86.618    52228.1  9132.2 12234.4     0.838      0.003      0.014   2777.329    834.095    897.016  1832.5  28837.8   202.5   148.8
Simulation ended.
lpjml successfully terminated, 67420 grid cells processed.
Wall clock time:	47318 sec, 8.8e-05 sec/cell/year.
Total wall clock time:	47323 sec (13:08:43).
</pre>

<h3>Error codes</h3>

If <tt>lpjml</tt> fails an error message is displayed in the following format</p>
<pre>
ERRORxxx: message
</pre>

where <tt>xxx</tt> is the error code returned. The following error codes are defined:</p>
<table border="1">
<tr bgcolor="#ccccff">
<th>Error code</th><th> Description</th><th>          Error type</th><th>
</tr>
<tr>
<td align="right">
1
</td><td>
Error reading configuration
</td><td>
External
</td></tr>
<tr>
<td align="right">
2
</td><td>
Error initializing input data
</td><td>
External
</td></tr>
<tr>
<td align="right">
3
</td><td>
Error initializing grid    
</td><td>
External
</td></tr>
<tr>
<td align="right">
4
</td><td>
Invalid carbon balance   
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
5
</td><td>
Invalid water balance    
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
6
</td><td>
Negative discharge    
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
7
</td><td>
Negative fire probability 
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
8
</td><td>
Negative soil moisture   
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
9
</td><td>
Error allocating memory 
</td><td>
External
</td></tr>
<tr>
<td align="right">
10
</td><td>
Negative stand fraction
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
11
</td><td>
Stand fraction sum error  
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
12
</td><td>
List is empty in <tt>dellistitem</tt>
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
13
</td><td>
Index out of range in <tt>dellistitem</tt>
</td><td> Internal
</td></tr>
<tr>
<td align="right">
15
</td><td>
Invalid year in <tt>getco2()</tt>
</td><td>
External
</td></tr>
<tr>
<td align="right">
16
</td><td>
Crop fraction >1     
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
17
</td><td>
No natural stand for deforest
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
18
</td><td>
Wrong cultivation type
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
19
</td><td>
Floating point error 
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
21
</td><td>
PFT list is not empty in <tt>setaside</tt>
</td><td>
Internal
</td></tr><tr>
<td align="right">
22
</td><td>
Negative establishment rate
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
23
</td><td>
Output channel is broken in socket connection
</td><td>
External 
</td></tr>
<tr>
<td align="right">
24
</td><td>
Sending data to IMAGE model failed
</td><td>
External
</td></tr>
<tr>
<td align="right">
25
</td><td>
Opening connection to IMAGE model failed
</td><td>
External
</td></tr>
<tr>
<td align="right">
26
</td><td>
Not enough setaside stand created
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
27
</td><td>
Forest left after deforestation
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
28
</td><td>
Outflow reservoir error
</td><td>
       Internal
</td></tr>
<tr>
<td align="right">
29
</td><td>
Permafrost error
</td><td>
	      Internal
</td></tr>
<tr>
<td align="right">
30
</td><td>
Global waterbalance error
</td><td>
     Internal
</td></tr>
<tr>
<td align="right">
31
</td><td>
Cannot store climate data
</td><td>
     External
</td></tr>
<tr>
<td align="right">
32
</td><td>
NO FMS coupler
</td><td>
		External
</td></tr>
<tr>
<td align="right">
33
</td><td>
Cannot initialize soil temperature  
</td><td>
External
</td></tr>
<tr>
<td align="right">
34
</td><td>
Invalid radiation model  
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
35
</td><td>
Negative soil NO3  
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
36
</td><td>
Negative soil NH4 
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
37
</td><td>
Invalid nitrogen balance
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
38
</td><td>
Invalid climate data
</td><td>
External
</td></tr>
<tr>
<td align="right">
39
</td><td>
Invalid FPC value
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
40
</td><td>
Boundary check error
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
41
</td><td>
Invalid time step in soiltemp()
</td><td>
Internal
</td></tr>
<tr>
<td align="right">
42
</td><td>
Cannot read external flow
</td><td>
External
</td></tr>
</table>

External errors are caused by invalid or missing input files while internal 
errors are caused by problems inside the LPJmL code. The latter will cause a core
dump and have to be fixed by program changes. Some errors will only be generated
if -DSAFE is set in the compile options of <tt>Makefile.inc</tt>. The options set at compile time can be obtained by invoking
<pre class="example">
% lpjml -v
lpjml C Version 5.1.001 (Nov  7 2018)
Operating system: Linux, little endian
Compiler:         Intel C version 15.00, 64 bit
Compile flags:    "-DUSE_RAND48 -DUSE_MPI -DSAFE -DWITH_FPE -DSTORECLIMATE -DUSE_NETCDF -DUSE_UDUNITS -DUSE_JSON "
</pre>
It is recommended to compile the code without optimization
and inlining making the inspection of the core file easier.
Configuring in $LPJROOT with
<pre class="example">
./configure.sh -debug
make clean
make
</pre>
will do the job. If no core file is generated set the user limit for core files:
<pre class="example">
% ulimit -c
0
% ulimit -c unlimited
</pre>
Then the core can be analysed with the <tt>gdb</tt> debugger:
<pre class="example">
gdb $LPJROOT/bin/lpjml core
</pre>
or by invoking the <A HREF="backtrace.html"><tt>backtrace</tt></A> script:
<pre class="example">
backtrace
</pre>
Additional checking for pointer access out of bounds can be done via
<pre class="example">
./configure.sh -check
make clean
make
</pre>
This option is only available for the Intel compiler and significantly slows down execution speed.

<h3>Building with Visual C++ 2005</h3>

<h4>How to get the software</h4>

Microsoft free version of the Visual Studio allows you to download the program, including a debugger. You can get it at <a href="https://www.visualstudio.com/downloads/">https://www.visualstudio.com/downloads</a> and choose Visual Studio Community.

The link might only work for the newest version 2017, since that is available now. You should still be able to download the 2015 version at <a href="https://www.microsoft.com/de-DE/download/details.aspx?id=48146">https://www.microsoft.com/de-DE/download/details.aspx?id=48146</A> or <a href="https://www.visualstudio.com/vs/older-downloads/">https://www.visualstudio.com/vs/older-downloads/</A>.

If you are working with windows systems anyway, this is a nice and handy developer environment. The main difference to alternatives (eclipse, text editors, etc.) is that VS uses no makefiles. Instead, you'll have to configure the project by hand.

However, you still may use the makefiles supplied with the code in windows systems, if you have VS C++ installed.

<h4>SVN management</h4>

The plugin VisualSVN (<a href="https://www.visualsvn.com/visualsvn/download/">download here</a>) allows for smoothly integrating the SVN functionality of Tortoise in Visual Studio and really makes things nice there.
However, it seems that PIK computers are member of an Active Directory domain, so buying a license is needed... :-(

<h4>Setting up a VS project</h4>
lick near the icon in the upper left to start a new project a new project on the downward arrow and choose 'start project from existing code', which starts a project wizard:<br>

<ul>

<li>What type of project: <i>Visual C++</i></li>

<li>general properties</li>

<ul>

<li>name your project</li>

<li>enter file location</li>

<li>check "add files to project from these folders"</li>

<li>check "add subfolders"</li>

<li>check "show all files in Solution Explorer"</li>

</ul>

<li>project type</li>

<ul>

<li>check "Use Visual Studio"</li>

<li>project type: "console application project"</li>

</ul>

<li>click <i>finish</i>, the rest can be
specified later</li>

</ul>
In case you are not able to create a project (error message: "Exception from HRESULT: 0x80041FE2"), go to the Windows control panel &rarr; uninstall a program &rarr; VS2015 &rarr; 'right click': change &rarr; MODIFY &rarr; drop down menu: Programming Languages &rarr; Visual C++ &rarr; check the box: 'Windows XP Support for C++' &rarr; Update
That should solve the problem and you can now create a project from existing code.
After the project has been created, you need to exclude all .c files from the project that are not essential to the code. This can be done in the Solution Explorer (upper left hand corner).
<ul>
<li>    exclude all files from the project that are not LPJ-essential (right click &rarr; exclude from project). This comprises in directory <tt>src</tt>: the file <tt>nooutput_gwb.c</tt> in directory <tt>lpj</tt>, <tt>utils</tt>, and <tt>lpj_climber4.c</tt>.
</ul>


Finally, you need to specify the project properties. For
this, right-click on the project in the <i>Solution Explorer</i>.</p>

<ul>

<li>configuration properties:</li>

<ul>

<li>General:</li>

<ul>

<li>character set &rarr; use Multi-Byte Character Set</li>

<li>IMPORTANT:
if you want to run the executable also on other computers you need to
statically link the libraries to the exe file. For this, choose "Use
MFC in static library"&nbsp;for the "Use of MFC" option. Otherwise,
this can
remain with the "Use Standard Windows Libraries"</li>

</ul>

<li>Debugging:</li>

<ul>

<li>Command arguments <tt>lpjml.conf</tt> <br>

</li>

<li>here, you can specify your working directory</li>

</ul>

<li>C/C++</li>

<ul>

<li>General:</li>

<ul>

<li>Additional include directories: add the
<tt>..\include</tt> directory here</li>

<li>Debug Information Format: C7 Compatible (<tt>/Z7</tt>)</li>

</ul>

<li>Optimization</li>

<ul>

<li>disabled (or whatever you want)<br>

</li>

</ul>

<li>Preprocessor</li>

<ul>

<li>preprocessor
definitions: basically, here all compiler Flags from the <tt>src/Makefile</tt>
can be specified, but without the "-D" prefix.</li>

<ul>

<li>Essential preprocessor definitions are: <tt>WIN32;
_DEBUG; _CONSOLE; SAFE; _USE_MATH_DEFINES; _CRT_SECURE_NO_DEPRECATE;</tt>
</li>

<li>optional: <tt>IMAGE</tt></li>

</ul>

</ul>

<li>Code Generation</li>

<ul>

<li>Enable Minimal Rebuild &rarr; No</li>

<li>Basic Runtime Checks &rarr; Default</li>

</ul>

<li>Advanced</li>

<ul>

<li>compile as &rarr; compile as C code (<tt>/TC</tt>)</li>

</ul>

</ul>

<li>Linker</li>

<ul>

<li>General</li>

<ul>
<li>under 'Enable Incremental Linking' &rarr; 'NO (/INCREMENTAL:NO)'


</ul>
<li>Input</li>
<ul>
  <li>Additional Dependencies &rarr; <tt>advapi32.lib ws2_32.lib</tt>
      </ul>

      </ul>

    </ul>

  </ul>

  Done. Now right-click on the project in the Solution
Explorer and select rebuild or build.

</ul>

<address>
Last change: 14 November 2018 by Werner von Bloh, PIK Potsdam
</address>
</BODY>
</HTML>
